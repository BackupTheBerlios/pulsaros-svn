#!/bin/sh

#
# changeconfig.sh - Change the config of a running embedded solaris
#		    and make it persistent 
#

CONF_NAME=/pulsarroot/bin/changes
BOOT_HOME=/pulsarroot
ARCHIVE_NAME=os

post_cleanup()
{
  if [ `df -k|awk '/\/tmp\/changes$/ { print $6 }'|wc -l` == 1 ]; then
    /usr/sbin/umount /tmp/changes
  fi
  if [ `lofiadm |wc -l` -gt 1 ]; then
   lofiadm -d /dev/lofi/1
  fi
  if [ -f /tmp/${ARCHIVE_NAME} ]; then
    rm /tmp/${ARCHIVE_NAME}
  fi
  if [ -f /tmp/${ARCHIVE_NAME}.gz ]; then
    rm /tmp/${ARCHIVE_NAME}.gz
  fi
}

#
# unzip the solemb archive and change the config
#
post_cleanup
cp ${BOOT_HOME}/boot/${ARCHIVE_NAME}.gz /tmp
gzip -d /tmp/${ARCHIVE_NAME}.gz
lofiadm -a /tmp/${ARCHIVE_NAME}
if [ ! -d /tmp/changes ]; then
  mkdir /tmp/changes
fi
mount /dev/lofi/1 /tmp/changes
for i in `cat ${CONF_NAME}`; do
  cp ${i} /tmp/changes/${i}
done
umount /tmp/changes
lofiadm -d /dev/lofi/1
rm -r /tmp/changes
gzip /tmp/${ARCHIVE_NAME}
cp /tmp/${ARCHIVE_NAME}.gz ${BOOT_HOME}/boot

exit 0
